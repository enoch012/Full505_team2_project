<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/jquery-3.7.0.js"></script>
    <!-- css파일 -->
    <link href="/css/style.css" rel="stylesheet">




    <script>
        $(document).ready(function () {

            let movieTitle = $("#title").text();
            getAllTable(movieTitle, '20230704');


            let nowMonth = new Date();  // 현재 달을 페이지를 로드한 날의 달로 초기화
            let today = initDate(new Date());     // 페이지를 로드한 날짜를 저장

            buildCalendarFrame();
            buildCalendar(today);
            // const todayStr = parseDate(new Date());
            // $("#date"+todayStr).addClass("active");

            $(".calBtn").on("click",function(){
                getAllTable(movieTitle, $(this).val().slice(4));
                $(".calBtn").removeClass("active");
                $(this).addClass("active");
            });

            $("#prev").on("click", function (){
                today.setMonth(today.getMonth()-1);
                buildCalendar(today);
                $(".calBtn").removeClass("active");
                let todayCell = $('button[value="date'+ parseDate(new Date()) +'"]');
                todayCell.addClass("active")
            });

            $("#next").on("click", function (){
                today.setMonth(today.getMonth()+1);
                buildCalendar(today);
                $(".calBtn").removeClass("active");
                let todayCell = $('button[value="date'+ parseDate(new Date()) +'"]');
                todayCell.addClass("active")
            });

            function buildCalendarFrame(){
                for(let i = 0; i<6; i++) {
                    // 일 ~ 토 까지 돌기
                    for (let j = 0; j < 7; j++) {
                        $("#calTr" + i).append("<td class='p-0'><button class='calBtn btn border-0' id='cal" + i + j + "'></button></td>");
                    }
                }
            };

            function buildCalendar(today) {
                const firstDateMonth = initDate(new Date(today.getFullYear(), today.getMonth(), 1));

                $("#calYear").text(today.getFullYear());
                $("#calMonth").text(today.getMonth()+1);

                let temp = firstDateMonth;

                $(".calBtn").removeClass("todayCell btn-outline-success");

                // tr 한줄씩 돌기
                for(let i = 0; i<6; i++) {
                    // 일 ~ 토 까지 돌기
                    for(let j = 0; j<7; j++) {
                        let cell = $("#calTr"+i+" td button#cal"+i+j);

                        // 현재 td의 인덱스가 월 첫째날의 요일 인덱스와 같을경우 data에 값 집어넣기
                        if(j == temp.getDay()) {
                            const dateStr = String(temp.getDate()).padStart(2, '0');
                            cell.val("date"+parseDate(temp));
                            cell.text(dateStr);
                            temp.setDate(temp.getDate()+1);
                        }
                        // 달의 첫째날이 일요일이 아닌경우 temp에 마이너스 며칠 해가지고 날짜를 맞춰서 temp를 재설정
                        else{
                            temp.setDate(temp.getDate()-temp.getDay());
                            const dateStr = String(temp.getDate()).padStart(2, '0');
                            cell.val("date"+parseDate(temp));
                            cell.text(dateStr);
                            temp.setDate(temp.getDate()+1);
                        }
                        // 이번달이 아닌 경우
                        let tempB = new Date(temp);
                        tempB.setDate(temp.getDate()-1);
                        if(tempB.getMonth() > today.getMonth() || tempB.getMonth() < today.getMonth()){
                            cell.addClass("btn-outline-secondary");
                        }
                        // 일요일
                        else if(j == 0) {
                            cell.addClass("btn-outline-danger");
                        }
                        // 토요일
                        else if(j == 6) {
                            cell.addClass("btn-outline-primary");
                        }
                        // 이번달 평일
                        else{
                            cell.addClass("btn-outline-dark");
                        }
                        if(cell.val().slice(4)<parseDate(new Date())){
                            cell.prop("disabled","true");
                            cell.parent().addClass("bg-secondary bg-opacity-10");
                        } else{
                            cell.prop("disabled","false");
                            cell.parent().removeClass("bg-secondary bg-opacity-10");
                        }
                    }
                }
                let todayCell = $('button[value="date'+ parseDate(new Date()) +'"]');
                todayCell.removeClass();
                todayCell.addClass("calBtn btn border-0 btn-outline-success todayCell active");
            }

            // Date 객체의 시,분,초,밀리초를 0으로 초기화시켜주는 함수
            function initDate (date) {
                date.setHours(0,0,0,0);
                return date;
            }

            // date를 yyyyMMdd로 변환, padStart는 2자리수, 첫째자리가 비었으면 0으로 채우는 문자열로 변환하는 함수
            function parseDate (date) {
                const returnDate = String(date.getFullYear()) +
                    String(date.getMonth() + 1).padStart(2, '0') +
                    String(date.getDate()).padStart(2, '0');

                return returnDate;
            }

            function getAllTable(title, date) {
                $("ul.timeTable li").remove();
                $("p.load").text("로딩 중...");
                $("p.load").css('display','block');
                getTable('cgv', title, date);
                getTable('megaBox', title, date);
                getTable('lotteCinema', title, date);
            }
            function removeTable(site) {
                $("ul#"+site+"Ul li").remove();
            }

            function getTable(site, movieTitle, date) {
                $.ajax({
                    // 접속할 서버의 주소 입력
                    url: "/detail/" + site + "/getTimetable.do",
                    // 서버와 통신 방식, GET/POST
                    type: "GET",
                    // 서버로 전송할 매개변수, JSON 방식으로 전송, 자바의 hashmap 타입과 비슷
                    // controller에서 RequestParam의 설정값과 동일해야함
                    data: {title: movieTitle, date: date},
                    // 통신 성공 시 전달받을 데이터의 타입 설정, json/text/html
                    dataType: "json",
                    // 통신 성공 시 동작하는 콜백함수
                    success: function (data) {
                        removeTable(site);
                        // 시간표결과가 없으면 정보없다고뜨고 있으면 로딩중... 이라는 p태그 지우기
                        if (data.length == 0) {
                            $("#" + site + "Load").text("상영 정보가 없습니다.");
                        } else {
                            $("#" + site + "Load").hide();
                        }

                        // MovieTimeTableDto 리스트 for문 돌리기
                        for (let i = 0; i < data.length; i++) {
                            // 상영관을 표시해주는 ul은 html에 미리 써놨고 상영관의 총 좌석수는 json파일에서 가져옴
                            let ul = $("#" + site + "Ul");
                            let tototalSeat = data[i].totalSeat;

                            // hall을 각 영화관 ul에 li로 추가
                            let hall = "<li class='list-unstyled' id='" + site + i + "'>" + "<span>" + data[i].hall + "</span>" + "</li>";
                            ul.append(hall);

                            // 시간과 잔여좌석이 표시되는 ul태그
                            let hallLi = $("#" + site + i);
                            hallLi.append("<ul class='clearfix'></ul>")
                            let timeUl = $("#" + site + "Ul > #" + site + i + " > ul");
                            let timeTable = data[i].startTimeAndSeatRemain;

                            // MovieTimeTableDto의 시간표인 timeTable for문 돌리기
                            for (let key in timeTable) {
                                let value = timeTable[key];
                                // 시간과 잔여좌석을 하나하나 li로 추가
                                let appendStr = "<li class=' border float-start m-1 py-1 px-2 list-unstyled text-center timeSeat'><strong>" + key + "</strong><br><span>" + value + "/" + tototalSeat + "</span></li>"
                                timeUl.append(appendStr)
                            }
                        }
                    },
                    // 통신 실패 시 동작하는 콜백함수
                    error: function () {
                        alert("ajax 통신 중 오류 발생")
                    }
                });
            }
        });
    </script>

</head>
<body>

<header th:replace="~{layout/header :: header-basic}"></header>
<main class="container-md my-4">
    <p>movie_pk</p>
    <p th:text="${movie.moviePk}"></p>
    <p>movie_title</p>
    <p id="title" th:text="${movie.movieTitle}"></p>
    <p>movie_like_cnt</p>
    <p th:text="${movie.movieLikeCnt}"></p>

    <hr>
    <div>
        <table class="Calendar table w-auto">
            <thead>
            <tr>
                <td><button type="button" id="prev"><</button></td>
                <td colspan="5" class="text-center">
                    <span id="calYear"></span><span>년</span>
                    <span id="calMonth"></span><span>월</span>
                </td>
                <td><button type="button" id="next">></button></td>
            </tr>
            <tr>
                <td>일</td>
                <td>월</td>
                <td>화</td>
                <td>수</td>
                <td>목</td>
                <td>금</td>
                <td>토</td>
            </tr>
            </thead>
            <tbody>
            <tr id="calTr0"></tr>
            <tr id="calTr1"></tr>
            <tr id="calTr2"></tr>
            <tr id="calTr3"></tr>
            <tr id="calTr4"></tr>
            <tr id="calTr5"></tr>
            </tbody>
        </table>

    </div>


    <hr>

    <div id="megaBox">
        <p>메가박스 <a href="https://www.megabox.co.kr/booking">홈페이지</a></p>
        <p id="megaBoxLoad" class="load">로딩 중..</p>
        <ul id="megaBoxUl" class="timeTable"></ul>
    </div>
    <div id="lotteCinema">
        <p>롯데시네마 <a href="https://www.lottecinema.co.kr/NLCHS/Ticketing">홈페이지</a></p>
        <p id="lotteCinemaLoad" class="load">로딩 중..</p>
        <ul id="lotteCinemaUl" class="timeTable"></ul>
    </div>
    <div id="cgv">
        <p>cgv <a href="http://www.cgv.co.kr/ticket/">홈페이지</a></p>
        <p id="cgvLoad" class="load">로딩 중..</p>
        <ul id="cgvUl" class="timeTable"></ul>
    </div>
    <hr>

</main>
<footer th:replace="~{layout/footer :: footer-basic}"></footer>
</body>
</html>